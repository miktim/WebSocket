<!DOCTYPE html>
<!--
 * WsServer test
 * MIT (c) 2020 miktim@mail.ru
-->
<html>
    <head>
        <title>WsServer test</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div></div>
        <script src="http://localhost:8080/http_request.js"></script>
        <script>
// see MDN: https://developer.mozilla.org/en-US/docs/Web/API/WebSocket
            var erruri = 'ws://localhost:8080/echo';
            var testuri = 'ws://localhost:8080/test/';
            var msg = 'Hello Server!';
            var testNo = 0;
            var tests = [
                "Check handler (request path) not found",
                "Check browser closure",
                "Check server handler closure",
                "Check message too big",
                "Check server stopped"
            ];
            var webSocket = [];
            try {
//                connectWs(erruri);
            testNo = 3;
            connectWs(testuri + testNo);
            } catch (e) {
                show('Exception: ' + e.code + ' ' + e.message);
            }
            function show(msg) {
                document.getElementsByTagName("div")[0]
                        .insertAdjacentHTML('beforeend', msg + '<br>');
            }
            function connectWs(uri) {
                if (testNo < tests.length)
                    show('Test ' + testNo + ": " + tests[testNo]);
                webSocket[testNo] = new WebSocket(uri);

                webSocket[testNo].onopen = event => {
// WebSocket: .url .readyState .bufferedAmount .binaryType             
                    show('onopen: ' + event.target.url);
                    event.target.send(msg);
                };

                webSocket[testNo].onmessage = event => {
// event: .data .origin .lastEventId .source .ports
//                    show('onmessage: ' + event.data + ":" + event.origin + ":" + event.source);
                    var url = event.target.url;
                    if (url.endsWith("1")) { // browser closure
                        if (event.data.length < 128)
                            event.target.send(event.data + event.data);
                        else
                            event.target.close();
                    } else if (url.endsWith("3")) { //message too big
                        event.target.send(event.data + event.data);
                    } else {
                        event.target.send(event.data);
                    }
                };
                webSocket[testNo].onerror = event => {
// event:                 
                    show("onerror: " + event.name + ":" + event.message);
                };
                webSocket[testNo].onclose = event => {
// event: .code .reason .wasClean
// see MDN: https://developer.mozilla.org/en-US/docs/Web/API/CloseEvent
                    show('onclose: ' + event.code
                            + ":" + event.reason + ":" + event.wasClean + '<br>');
/*
                    if (testNo < 4)
                        connectWs(testuri + ++testNo);
                    else if (testNo === 4) {
                        connectWs(testuri + ++testNo);
                        connectWs(testuri + ++testNo);
                        connectWs(testuri + ++testNo);
                    }
*/
                };
            }

        </script>
    </body>

</html>
