<!DOCTYPE html>
<!--
  WsServer test, MIT (c) 2020 miktim@mail.ru
-->
<html>
    <head>
        <title>WsServer test</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div>WsServer test<br><br></div>
        <script src="http://localhost:8080/http_request.js"></script>
        <script>
// see MDN: https://developer.mozilla.org/en-US/docs/Web/API/WebSocket
            var erruri = 'ws://localhost:8080/echo';
            var testuri = 'ws://localhost:8080/test/';
            var msg = 'Hello Server!';
            var maxMsgLength = 0;
            var testNo = 0;
            var tests = [
                'server handler (request path) not found (1008 expected)',
                'closing websocket by browser (1005 expected)',
                'closing websocket by the server handler (1000 expected)',
                'waiting message too big (1009 expected)',
                'waiting for server shutdown (1001 expected)'
            ];

            try {
                connectWs(erruri);
//            testNo = 3;
//            connectWs(testuri + testNo);
            } catch (e) {
                show('Exception: ' + e.code + ' ' + e.message);
            }
            function show(msg) {
                document.getElementsByTagName("div")[0]
                        .insertAdjacentHTML('beforeend', msg + '<br>');
            }
            function connectWs(uri) {
                if (testNo < tests.length)
                    show('Test' + testNo + ': ' + tests[testNo]);
                var webSocket = new WebSocket(uri);
                webSocket.onopen = event => {
// WebSocket: .url .readyState .bufferedAmount .binaryType             
                    show('onopen: ' + event.target.url);
                    event.target.send(msg);
                };
                webSocket.onmessage = event => {
// event: .data .origin .lastEventId .source .ports

                    var url = event.target.url;
                    if (url.endsWith('1')) { // browser closure
                        show('onmessage: ' + event.data);
                        if (event.data.length < 80)
                            event.target.send(event.data + event.data);
                        else
                            event.target.close();
                    } else if (url.endsWith('3')) { //message too big
                        maxMsgLength = event.data.length;
                        event.target.send(event.data + event.data);
                    } else {
                        event.target.send(event.data);
                    }
                };
                webSocket.onerror = event => {
// event:                 
                    show('onerror: ' + event.name + ':' + event.message);
                };
                webSocket.onclose = event => {
// event: .code .reason .wasClean
// see MDN: https://developer.mozilla.org/en-US/docs/Web/API/CloseEvent
                    show('onclose: ' + event.code
                            + ':' + event.reason
                            + ':' + event.wasClean
                            + ':' + event.target.url + '<br>');

                    if (++testNo < tests.length)
                        connectWs(testuri + testNo);
                    else
                        show('Test finished');
                };
            }

        </script>
    </body>

</html>
